<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lake Erie Perch Fishing Conditions</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; color:#333; margin:20px; }
    h1, .h1 { text-align:center; }
    .container { max-width:1000px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); }
    img { width:100%; border-radius:8px; }   
    #gradeDesc { font-size:1.2em; text-align:center; font-weight:bold; margin: 0 0}
    #gradeSubDesc { font-size:1em; text-align:center; font-weight:normal; margin-top: 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #ccc; text-align:left; }
    th { background:#f0f0f0; }
    canvas { margin-top:20px; }
    section { margin-bottom:20px; }
    .grade { font-size:2.5em; text-align:center; margin:15px 0; font-weight:bold; }
    .A { color:green; }
    .B { color:#4CAF50; }
    .C { color:orange; }
    .D { color:#E67E22; }
    .F { color:red; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function corsBypass(url) {
      return `https://cors-anywhere.herokuapp.com/${encodeURI(url)}`;
    }

    function corsBypass2(url) {
      return `https://api.allorigins.win/raw?url=${encodeURI(url)}`;
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Lake Erie Perch Fishing Conditions</h1>
    <section>
      <h2>Live Buoy Cam</h2>
      <iframe id="buoyCam"
        style="width:100%; min-height:350px; border:0;"
        scrolling="no"
        title="Buoy Cam 45005">
      </iframe>
	  </section>
    <section>
      <h2>Fishing Condition Grade</h2>
      <div class="grade" id="grade">--</div>
      <p style="text-align:center;" id="gradeDesc">Loading conditions...</p>
      <p style="text-align:center;" id="gradeSubDesc"></p>    
    </section>
    <section>
      <h2>Latest Buoy Data (Imperial Units)</h2>
      <table>
        <tr><th>Measurement</th><th>Value</th></tr>
        <tr><td>Water Temperature</td><td id="waterTemp">--</td></tr>
        <tr><td>Air Temperature</td><td id="airTemp">--</td></tr>
        <tr><td>Wind Speed</td><td id="windSpeed">--</td></tr>
        <tr><td>Wave Height</td><td id="waveHeight">--</td></tr>
      </table>
    </section>
    <section>
      <h2>Wave Height</h2>
      <canvas id="waveChart" height="200"></canvas>
      <h2>Water & Air Temperature</h2>
      <canvas id="tempChart" height="200"></canvas>
    </section>

  <script>
    let waveChart, tempChart;
    const dataBuoyId = 45203;
    const imageBuoyId = 45005;

    document.getElementById("buoyCam").src = corsBypass2(`https://www.ndbc.noaa.gov/buoycam.php?station=${imageBuoyId}`);
    
    async function fetchBuoyData() {
      try {
          let attempts = 3;
          let success = false;
          const buoyUrl = corsBypass(`https://www.ndbc.noaa.gov/data/realtime2/${dataBuoyId}.txt`);

         do {
            try {
              const response = await fetch(buoyUrl);
              text = await response.text();
              success = true;
            } catch (error) {
              console.error("Error fetching buoy data:", error);
            }
          } while (--attempts > 0);
            if(!success)
              throw new Error("Failed to fetch buoy data after multiple attempts.");             

        const lines = text.trim().split("\n");
        const recent = lines.slice(2, 68); // ~24 hrs

        const times = [];
        const waveHeights = [];
        const waterTemps = [];
        const airTemps = [];

        recent.forEach(line => {
          const parts = line.trim().split(/\s+/);
          if (parts.length < 15) return;
          const YYYY = parts[0],
            MM = parts[1],
            DD = parts[2],
            hh = parts[3],
            mm = parts[4];
          const waveM = parseFloat(parts[8]);
          const wtmpC = parseFloat(parts[14]);
          const atmpC = parseFloat(parts[13]);

          times.push(new Date(`${YYYY}-${MM}-${DD}T${hh}:${mm}:00Z`).toLocaleString());
          waveHeights.push((waveM * 3.281).toFixed(2));
          waterTemps.push(((wtmpC * 9/5) + 32).toFixed(1));
          airTemps.push(((atmpC * 9/5) + 32).toFixed(1));
        });

        // Latest row
        const latest = recent[0].trim().split(/\s+/);
        const wspd = parseFloat(latest[6]);  // m/s
        const gust = parseFloat(latest[7]);  // m/s
        const atmp = parseFloat(latest[13]); // °C
        const wtmp = parseFloat(latest[14]); // °C
        const wave = parseFloat(latest[8]);  // m

        // Conversions
        const windMph = (wspd * 2.237).toFixed(1);
        const gustMph = (gust * 2.237).toFixed(1);
        const airF = (atmp * 9/5 + 32).toFixed(1);
        const waterF = (wtmp * 9/5 + 32).toFixed(1);
        const waveFt = (wave * 3.281).toFixed(1);

        // Update table
        document.getElementById("waterTemp").textContent = `${waterF} °F`;
        document.getElementById("airTemp").textContent = `${airF} °F`;
        document.getElementById("windSpeed").textContent = `${windMph} mph (gusts ${gustMph} mph)`;
        document.getElementById("waveHeight").textContent = `${waveFt} ft`;

        // Grading logic

        let tempScore = tempScoreParabolic(waterF)
        let windScore = Math.max(0, 100 - (windMph * 5)); // 0 at 20 mph
        let waveScore = Math.max(0, 100 - (waveFt * 12)); // 0 at 4 ft

        const tempWeight = .5;
        const windWeight = .1;
        const waveWeight = .4;

        let overallScore = (tempScore * tempWeight) + (windScore * windWeight) + (waveScore * waveWeight);

        console.log(`Scores - Temp: ${tempScore.toFixed(1)}, Wind: ${windScore.toFixed(1)}, Wave: ${waveScore.toFixed(1)}, Overall: ${overallScore.toFixed(1)}`);

        let grade = "C";
        let gradeDesc = "";
        if (overallScore >= 90) {
          grade = "A"; gradeDesc = "Great";
        } else if (overallScore >= 80) {
          grade = "B"; gradeDesc = "Good";
        } else if (overallScore >= 70) {
          grade = "C"; gradeDesc = "OK";
        } else if (overallScore >= 60) {
          grade = "D"; gradeDesc = "Poor";
        } else {
          grade = "F"; gradeDesc = "Potentially unsafe";
        }

        let gradeSubDesc = "";
        let lowestScore = Math.min(tempScore, windScore, waveScore);
        if(lowestScore === tempScore && tempScore < 70) {
          gradeSubDesc += "Water temperature is not ideal.";
        } else if(lowestScore === windScore && windScore < 70) {
          gradeSubDesc += "Wind may make fishing difficult.";
        } else if(lowestScore === waveScore && waveScore < 70) {
          gradeSubDesc += "High waves may make fishing difficult.";
        }

        const gradeDiv = document.getElementById("grade");
        gradeDiv.textContent = grade;
        gradeDiv.className = "grade " + grade;

        document.getElementById("gradeDesc").textContent = gradeDesc;
        document.getElementById("gradeSubDesc").textContent = gradeSubDesc;

        // Charts
        if (waveChart) waveChart.destroy();
        if (tempChart) tempChart.destroy();
     
        times.reverse();
        waveHeights.reverse()
        waterTemps.reverse();
        airTemps.reverse();

        waveChart = new Chart(document.getElementById("waveChart"), {
          type: "line",
          data: { 
			      labels: times,
			      datasets: [
              { 
                label: "Wave Height (ft)",
                data: waveHeights,
                borderColor: "blue",
                fill: false
              }
            ]
		      },
          options: {
            responsive: true,
            scales: {
              y: {
                  beginAtZero: true,
                  suggestedMax: 4,
                  stepSize: 1
              }
            }
          }
        });
        tempChart = new Chart(document.getElementById("tempChart"), {
          type: "line",
          data: { 
            labels: times,
            datasets: [
              {
                label: "Water Temperatures (°F)",
                data: waterTemps,
                borderColor: "blue",
                fill: false
              },
              {
                label: "Air Temp (°F)",
                data: airTemps,
                borderColor: "red",
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { 
                beginAtZero: false,
                suggestedMax: 80,
                suggestedMin: 40,
                stepSize: 2
              }
            }
          }
        });

        //throw new Error("Debug: Data fetched and processed successfully.");
      } catch (err) {
        console.error("Error fetching buoy data:", err);
        document.getElementById("gradeDesc").innerHTML = "Error loading buoy data.<br/> NOTE: You may need to click <a href=\"https://cors-anywhere.herokuapp.com/\">here</a> and 'accept' to load data.";
      }
    }

    function tempScoreParabolic(temp, peak = 67, low = 40, high = 72, scale = .8) {
      const halfWidth = Math.min(peak - low, high - peak);
      const a = -100 / ((halfWidth / scale) ** 2);
      let score = a * ((temp - peak) ** 2) + 100;

      // Only clamp if outside the valid range
      if (temp < low || temp > high) {
        return 0;
      }
      return score;
    }

    fetchBuoyData();
  </script>
</body>
</html>
